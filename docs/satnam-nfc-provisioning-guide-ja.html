<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Satnam NFC Provisioning Guide</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Satnam用のNTAG424 NFCフィジカルMFAを安全にプロビジョニングするためのエンドユーザークイックスタート" />
  <style>
    :root{--bg:#fff;--fg:#111;--muted:#555;--accent:#0b74de;--warn:#b00020;--ok:#0a7f3f}
    *{box-sizing:border-box} body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;color:var(--fg);background:var(--bg);}
    header{padding:24px;border-bottom:1px solid #eee}
    h1{margin:0 0 4px;font-size:26px} h2{margin:24px 0 8px;font-size:20px} h3{margin:18px 0 6px;font-size:16px}
    p{line-height:1.55;margin:8px 0} ul{margin:8px 0 8px 20px} li{margin:6px 0}
    .container{max-width:960px;margin:0 auto;padding:24px}
    .grid{display:grid;gap:16px} .two{grid-template-columns:1fr 1fr} .three{grid-template-columns:repeat(3,1fr)}
    .card{border:1px solid #eee;border-radius:8px;padding:16px}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#eee;color:#333;font-size:12px;margin-right:6px}
    .callout{border-left:4px solid var(--accent);padding:12px 12px 12px 16px;background:#f8fbff}
    .danger{border-left-color:var(--warn);background:#fff7f8}
    .ok{border-left-color:var(--ok);background:#f7fff9}
    code,kbd{background:#f2f2f2;padding:2px 6px;border-radius:4px}
    .steps ol{margin:8px 0 8px 20px} .steps li{margin:8px 0}
    .diagram{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;background:#fafafa;border:1px solid #eee;border-radius:6px;padding:12px;white-space:pre;overflow:auto}
    .lang-nav{text-align:center;margin:16px 0;padding:12px;background:#f0f0f0;border-radius:6px}
    .lang-nav a{margin:0 8px;color:var(--accent);text-decoration:none;font-weight:500}
    .lang-nav a:hover{text-decoration:underline}
    @media print{header .lang-nav,.no-print{display:none}.container{padding:0} a[href]::after{content:" (" attr(href) ")";font-size:10px;color:#666}}
  </style>
</head>
<body>
  <header>
    <h1>Satnam NFC Provisioning Guide</h1>
    <div style="color:var(--muted);font-size:16px;margin-top:8px">NTAG424 NFC Physical MFA • プライバシーファースト • ゼロナレッジ</div>
    <div class="lang-nav no-print">
      <strong>言語:</strong>
      <a href="satnam-nfc-provisioning-guide.html">English</a>
      <a href="satnam-nfc-provisioning-guide-es.html">Español</a>
      <a href="satnam-nfc-provisioning-guide-de.html">Deutsch</a>
      <a href="satnam-nfc-provisioning-guide-ja.html">日本語</a>
    </div>
  </header>
  <div class="container">

    <div class="callout ok">
      <strong>目標</strong>: 別のハードウェアブリッジなしで、Satnam NFC Physical MFAのNTAG424タグを安全にプロビジョニングします。すべての検証は、ローカルSUN/CMAC チェックを使用してSatnamsのNetlify関数によって実行されます。
      <br/><br/>
      <strong>ステータス</strong>: ✅ 本番環境対応 (フェーズ6完了 • 74テスト合格 • 100%カバレッジ)
    </div>

    <h2>1) Boltcardでのプロビジョニング (Androidのみ)</h2>
    <div class="card">
      <div class="badge">単一パス</div>
      <h3>Android (Boltcardプログラミングアプリ)</h3>
      <ul>
        <li>NFC対応のAndroidスマートフォン</li>
        <li>アプリ: Boltcard NFCプログラミングアプリ</li>
        <li>最速で公式にサポートされているパス</li>
      </ul>
      <p><strong>ダウンロード</strong>:</p>
      <ul>
        <li>リリース (APK): https://github.com/boltcard/bolt-nfc-android-app/releases</li>
        <li>Play Store: https://play.google.com/store/apps/details?id=com.lightningnfcapp</li>
      </ul>
    </div>

    <div class="callout" style="margin-top:12px">
      <strong>次のステップ:</strong> ネームタグをプロビジョニングした後、Satnamsランディングページに戻り、<em>"Register/Signin Your Name Tag"</em>をクリックして登録/認証を完了します。
      <br/>
      <strong>参照:</strong> 外部Boltcardセットアップガイド: <a href="https://ereignishorizont.xyz/en/boltcard_en/" target="_blank" rel="noopener noreferrer">ereignishorizont.xyz/en/boltcard_en/</a>
    </div>

    <div class="callout" style="margin-top:12px">
      <strong>iOSユーザー</strong>: Androidデバイスを借りるか、コミュニティプロビジョニングステーションにアクセスしてタグをプログラミングしてください。プログラミング後、タグはiOSでタップ/検証に対応します。
    </div>

    <div class="callout danger" style="margin-top:12px">
      <strong>セキュリティ上重要</strong>: プロビジョニングブロブ (K0/K1/K2、SDM設定) をセキュアデバイスの外で共有しないでください。パスワードマネージャーに保存してください。タグで変更した後にキーを失った場合、そのタグを再プログラミングすることはできません。
    </div>

    <h2>2) Satnamsからプロビジョニングブロブを取得</h2>
    <p>Satnamsで: Security → NFC Physical MFA → "Provision new tag"。これは<code>/nfc-unified/initialize</code>を呼び出し、以下を含むJSONブロブ (クライアント側のみ) を提供します:</p>
    <ul>
      <li><code>url_base</code> — 書き込むNDEF URL (例: https://www.satnam.pub/nfc/scan)</li>
      <li><code>k0</code>, <code>k1</code>, <code>k2</code> — AESキー (16進数)</li>
      <li><code>sdm</code> — SUN/SDM有効化 + オフセット (PICC/CMAC挿入)</li>
    </ul>

    <h2>3) プロビジョニング手順 (Boltcard Android)</h2>
    <div class="steps card">
      <ol>
        <li>Boltcardアプリ (APK/Play) をインストールしてNFCを有効にします。</li>
        <li><em>Key change</em>を開く → Satnamsから提供されたとおりに<code>K0/K1/K2</code>を適用します (プロビジョニングブロブから)。</li>
        <li><strong>SDM/SUN</strong>を有効にし、ブロブごとにオフセットを設定して、<code>PICC</code> (UID) と<code>CMAC</code>がURLに追加されるようにします。</li>
        <li>NDEF URLをベースに設定します: <code>https://www.satnam.pub/t/&lt;duid&gt;</code>。SDMパラメータは読み取り時に<code>?sdm=...&amp;u=...</code>として追加されます。</li>
        <li>オプション: プライバシーのためにUID ランダム化を有効にします (不可逆)。</li>
        <li>プログラミングが成功するまで、タグをスマートフォンで静止させたままにします。</li>
      </ol>
    </div>

    <h2>4) タグを検証</h2>
    <ul>
      <li><strong>クイック</strong>: 任意のNFCスマートフォンでタップします。開いたURLには動的SDMパラメータが含まれている必要があります (例: CMAC/PICC)。</li>
      <li><strong>Satnam エンドツーエンド</strong>: タップ → アプリがSatnamsを開く → フロントエンドがSDMフィールドで<code>/nfc-unified/verify</code>を呼び出す → 成功応答。</li>
      <li><strong>低レベル</strong>: TagXplorerを使用してキー、SDM有効化、およびNDEF URLレコードを確認します。</li>
    </ul>

    <h2>5) 統合方法 (一目で)</h2>
    <div class="diagram">ユーザータップ → スマートフォンがNDEF url_baseを開く
   → フロントエンドがSDMパラメータ (PICC/CMAC) をキャプチャ
   → Netlify関数 /nfc-unified/verify
   → Netlify関数経由のSUN/CMAC検証 (設定時にハードウェアブリッジを強制)
   → セッション/認証成功
   → (オプション) LNbits Boltcardsはウォレット/レジストリメタデータのみに使用
    </div>

    <h2>6) トラブルシューティング</h2>
    <ul>
      <li><strong>書き込み失敗 / タグが移動</strong>: タグを完全に静止させたままにします。再試行してください。スマートフォンのNFCコイルがタグアンテナと一致していることを確認してください。</li>
      <li><strong>URLにCMACがない</strong>: SDMが有効になっていないか、オフセットが正しくありません。ブロブごとにSDM設定を再度適用してください。</li>
      <li><strong>再プログラミングできない</strong>: キーが変更されましたが失われました。正しいキーなしではタグを再プロビジョニングできません。</li>
      <li><strong>デスクトップリーダーの問題</strong>: PN532またはNTAG424サポート付きのNXPリーダーを使用してください。古いACR122Uは避けてください。</li>
      <li><strong>Androidエラー</strong>: アプリを再インストールしてください。デバイスのNFCがオンになっており、他のNFCアプリが干渉していないことを確認してください。</li>
    </ul>

    <h2>7) ベストプラクティス</h2>
    <ul>
      <li>制御された環境でプロビジョニングします (近くに不明なNFCデバイスがない)。</li>
      <li>プロビジョニングブロブをパスワードマネージャーに保存します。メールやチャットで送信しないでください。</li>
      <li>最初にスペアタグでテストします。<code>/nfc-unified/verify</code>から成功ログを記録します。</li>
    </ul>

    <h2>8) 追加リソース</h2>
    <div class="card">
      <p><strong>ドキュメント & ツール</strong></p>
      <ul>
        <li><a href="/docs/NFC_TROUBLESHOOTING.md" target="_blank" rel="noopener noreferrer">トラブルシューティングガイド</a> - 一般的な問題と解決策</li>
        <li><a href="/docs/NFC_API_ENDPOINTS.md" target="_blank" rel="noopener noreferrer">APIリファレンス</a> - 完全なエンドポイントドキュメント</li>
        <li><a href="/docs/NFC_SECURITY_ARCHITECTURE.md" target="_blank" rel="noopener noreferrer">セキュリティアーキテクチャ</a> - 暗号化標準とRLSポリシー</li>
        <li><a href="/docs/NFC_FEATURE_FLAGS.md" target="_blank" rel="noopener noreferrer">フィーチャーフラグガイド</a> - 設定と環境セットアップ</li>
        <li><a href="/docs/ntag424-blob-viewer.html" target="_blank" rel="noopener noreferrer">Blob Viewerツール</a> - カードファイルの内容を検査</li>
      </ul>
    </div>

    <div class="callout ok" style="margin-top:12px">
      <strong>本番環境ステータス</strong>: このガイドは、74テスト合格 (36ユニット + 19統合 + 19 E2E) によるフェーズ6完了を反映しています。すべてのセキュリティ標準が検証されました。ゼロナレッジアーキテクチャが確認されました。本番環境への展開の準備ができています。
    </div>

    <p class="no-print" style="margin-top:24px;color:var(--muted)">ヒント: ブラウザの印刷 → "PDFとして保存"を使用してこのガイドをエクスポートします。</p>
  </div>
</body>
</html>
